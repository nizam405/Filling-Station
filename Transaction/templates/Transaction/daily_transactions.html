{% extends 'base.html' %}
{% block title %}Daily Transactions{% endblock title %}

{% block style %}
<style>
    #date-filter .bootstrap4-multi-input div.col-4 {
        padding: 0;
    }

    #date-filter select, #buttons button, #buttons a {
        border-radius:0rem;
    }

    #transaction-table table tr td:nth-child(2) {
        white-space: nowrap;
    }
</style>
{% endblock style %}

{% block main %}

{% load extra_tags %}
{% load bootstrap4 %}

<div class="row container-fluid px-0 d-print-none">
    <div class="col-md-9">
        <form method="get" class="row">
            <div class="col-sm-8 col-lg-8" id="date-filter">
                {% bootstrap_form date_form layout='horizontal' label_class='col-sm-2 py-2' field_class='col-sm-10' bound_css_class=""%}
            </div>
            <div class="col-sm-4 col-lg-4" id="buttons">
                {% bootstrap_button "Go" button_type="submit" %}
                <a href="{% url 'daily-transactions' prev_day %}" class="btn btn-info"><i class="bi bi-chevron-left"></i></a>
                <a href="{% url 'daily-transactions' next_day %}" class="btn btn-info"><i class="bi bi-chevron-right"></i></a>
            </div>
        </form>
    </div>
    <div class="col-md-3">
        <div class="row">
            <div class="col-md-9">
                <div class="form-check p-2">
                    <input type="checkbox" class="form-check-input" id="show-subtotal" checked=True >
                    <label for="show-subtotal" class="form-check-label">Show Subtotal</label>
                </div>
            </div>
            <div class="col-md-3">
                <i id="print" class="bi bi-printer btn p-0" style="font-size: 1.5rem"></i>
            </div>
        </div>
    </div>
</div>
<div class="text-center">
    <h3 class="d-none d-print-block bangla">প্রধান সি এন জি এন্ড ফিলিং স্টেশন</h3>
    <h3 class="bangla">দৈনিক লেনদেন</h3>
    <h5 class="d-none d-print-block"><span class="bangla">তারিখ:</span> {{date_str}}</h5>
</div>

<div class="row" id="transaction-table">
    {% if active_accounts %}
    <div class="col-md-6 pr-1">
        <div class="bangla">ডেবিট
            {% if can_change %}
            <span id="dr-plus" class="d-print-none"><i class="bi bi-plus-circle text-info"></i>
                <div id="dr-add-btn" class="card">
                    <a class="d-block nav-link" href="{% url 'create-sell-multi' date %}">মাল বিক্রয়</a>
                    <a class="d-block nav-link" href="{% url 'create-revenue-multi' date %}">আয়</a>
                    <a class="d-block nav-link" href="{% url 'create-duecollection-multi' date %}">বকেয়া আদায়</a>
                </div>
            </span>
            {% endif %}
        </div>
        <table class="table table-sm table-bordered left2nd">
            <tr class="text-center bangla">
                <th>বিবরন</th>
                <th>পরিমান</th>
                <th>টাকা</th>
                <th class="subtotal">টাকা</th>
            </tr>
            {% if balance_bf_side == 'debit' %}
            <tr>
                <td colspan="3" class="cp-3"><span class="bangla">ব্যাল্যান্স</span> B/F ({{balance_bf_date}})</td>
                <td class="text-right">{{balance_bf_abs|ezynumber}}</td>
            </tr>
            {% endif %}

            {% if sells %}
            <tr>
                <th colspan="4" class="bangla group-label">মাল বিক্রয়
                    {% if can_change %}
                    <a href="{% url 'create-sell-multi' date %}" class="d-print-none"><i class="bi bi-plus-circle text-info"></i></a>
                    {% endif %}
                </th>
            </tr>
            {% for obj in sells %}
            <tr class="transaction-entry">
                {% if obj.product.type == "Loose" %}
                <td class="bangla">
                    ({{obj.product.get_type_display}}) {{obj.product.name}}
                </td>
                <td class="text-right">{{obj.quantity|ezynumber}} <span class="bangla">লিঃ</span></td>
                {% else %}
                <td>
                    {{obj.product.brand}} <span class="bangla">({{obj.product.name}})</span>
                </td>
                <td class="text-right">{{obj.product.capacity}} <span class="bangla">লিঃ</span> &times; {{obj.quantity|floatformat:"-2"}} </td>
                {% endif %}
                <td class="text-right">{{obj.amount|ezynumber}}</td>
                <td class="subtotal">{% if can_change %}
                    <div class="d-print-none action-btns">
                        <a href="{% url 'update-sell' pk=obj.pk %}"><i class="bi bi-pencil-square text-dark"></i></a>
                        <a href="{% url 'delete-sell' pk=obj.pk %}"><i class="bi bi-trash text-danger"></i></a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr class="subtotal">
                <td colspan="3" class="bangla cp-3 text-right">মোটঃ</td>
                <td class="text-right">{{total_sell|ezynumber}}</td>
            </tr>
            {% endif %}

            {% if revenues %}
            <tr>
                <th colspan="4" class="bangla group-label">আয়
                    {% if can_change %}
                    <a href="{% url 'create-revenue-multi' date %}" class="d-print-none"><i class="bi bi-plus-circle text-info"></i></a>
                    {% endif %}
                </th>
            </tr>
            {% for revenue in revenues %}
            <tr class="transaction-entry">
                <td colspan="2" class="bangla">{{revenue.group.name}}
                    {% if revenue.detail %}-{{revenue.detail}}{% endif %}
                </td>
                <td class="text-right">{{revenue.amount|ezynumber}}</td>
                <td class="subtotal">
                    {% if can_change %}
                    <div class="d-print-none action-btns">
                        <a href="{% url 'update-revenue' pk=revenue.pk %}" class="p-1"><i class="bi bi-pencil-square text-dark"></i></a>
                        <a href="{% url 'delete-revenue' pk=revenue.pk %}" class="p-1"><i class="bi bi-trash text-danger"></i></a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr class="subtotal">
                <td colspan="3" class="bangla cp-3 text-right">মোটঃ</td>
                <td class="text-right">{{total_revenues|ezynumber}}</td>
            </tr>
            {% endif %}

            {% if duecollections %}
            <tr>
                <th colspan="4" class="bangla group-label">বকেয়া আদায়
                    {% if can_change %}
                    <a href="{% url 'create-duecollection-multi' date %}" class="d-print-none"><i class="bi bi-plus-circle text-info"></i></a>
                    {% endif %}
                </th>
            </tr>
            {% for duecollection in duecollections %}
            <tr class="transaction-entry">
                <td colspan="2" class="bangla">{{duecollection.customer}}</td>
                <td class="text-right">{{duecollection.amount|ezynumber}}</td>
                <td class="subtotal">
                    {% if can_change %}
                    <div class="d-print-none action-btns">
                        <a href="{% url 'update-duecollection' pk=duecollection.pk %}" class="p-1"><i class="bi bi-pencil-square text-dark"></i></a>
                        <a href="{% url 'delete-duecollection' pk=duecollection.pk %}" class="p-1"><i class="bi bi-trash text-danger"></i></a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr class="subtotal">
                <td colspan="3" class="bangla cp-3 text-right">মোটঃ</td>
                <td class="text-right">{{total_duecollections|ezynumber}}</td>
            </tr>
            {% endif %}

            <tr>
                <th colspan="3" class="bangla cp-3 text-right">সর্বমোটঃ</th>
                <th class="text-right">{{total_debit|ezynumber}}</th>
            </tr>
        </table>
    </div>

    <div class="col-md-6 pl-1">
        <div class="text-right bangla">ক্রেডিট
            {% if can_change %}
            <span id="cr-plus" class="d-print-none"><i class="bi bi-plus-circle text-info"></i>
                <div id="cr-add-btn" class="card">
                    <a class="d-block nav-link" href="{% url 'create-purchase-multi' date %}">মাল ক্রয়</a>
                    <a class="d-block nav-link" href="{% url 'create-expenditure-multi' date %}">ব্যয়</a>
                    <a class="d-block nav-link" href="{% url 'create-duesell-multi' date %}">বাকি বিক্রয়</a>
                    <a class="d-block nav-link" href="{% url 'create-withdraw-multi' date %}">উত্তোলন</a>
                </div>
            </span>
            {% endif %}
        </div>
        <table class="table table-sm table-bordered left2nd">
            <tr class="text-center bangla">
                <th>বিবরন</th>
                <th>পরিমান</th>
                <th>টাকা</th>
                <th class="subtotal">টাকা</th>
            </tr>
            
            {% if balance_bf_side == 'credit' %}
            <tr>
                <td colspan="3" class="cp-3"><span class="bangla">ব্যাল্যান্স</span> B/F ({{balance_bf_date}})</td>
                <td class="text-right">{{balance_bf_abs|ezynumber}}</td>
            </tr>
            {% endif %}

            {% if purchases %}
            <tr>
                <th colspan="4" class="bangla group-label">মাল ক্রয়
                    {% if can_change %}
                    <a href="{% url 'create-purchase-multi' date %}" class="d-print-none"><i class="bi bi-plus-circle text-info"></i></a>
                    {% endif %}
                </th>
            </tr>
            {% for obj in purchases %}
            <tr class="transaction-entry">
                {% if obj.product.type == "Loose" %}
                <td class="bangla">
                    ({{obj.product.get_type_display}}) {{obj.product.name}}
                </td>
                <td class="text-right">{{obj.quantity|ezynumber}} <span class="bangla">লিঃ</span></td>
                {% else %}
                <td>
                    {{obj.product.brand}} <span class="bangla">({{obj.product.name}})</span>
                </td>
                <td class="text-right">{{obj.product.capacity}} <span class="bangla">লিঃ</span> &times; {{obj.quantity|floatformat:"-2"}} </td>
                {% endif %}
                <td class="text-right">{{obj.amount|ezynumber}}</td>
                <td class="subtotal">{% if can_change %}
                    <div class="d-print-none action-btns">
                        <a href="{% url 'update-purchase' pk=obj.pk %}"><i class="bi bi-pencil-square text-dark"></i></a>
                        <a href="{% url 'delete-purchase' pk=obj.pk %}"><i class="bi bi-trash text-danger"></i></a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr class="subtotal">
                <td colspan="3" class="bangla cp-3 text-right">মোটঃ</td>
                <td class="text-right">{{total_purchase|ezynumber}}</td>
            </tr>
            {% endif %}

            {% if expenditures %}
            <tr>
                <th colspan="4" class="bangla group-label">ব্যয়
                    {% if can_change %}
                    <a href="{% url 'create-expenditure-multi' date %}" class="d-print-none"><i class="bi bi-plus-circle text-info"></i></a>
                    {% endif %}
                </th>
            </tr>
            {% for expenditure in expenditures %}
            <tr class="transaction-entry">
                <td colspan="2" class="bangla">{{expenditure.group.name}}
                    {% if expenditure.detail %}- {{expenditure.detail}}{% endif %}
                </td>
                <td class="text-right">{{expenditure.amount|ezynumber}}</td>
                <td class="subtotal">
                    {% if can_change %}
                    <div class="d-print-none action-btns">
                        <a href="{% url 'update-expenditure' pk=expenditure.pk %}"><i class="bi bi-pencil-square text-dark"></i></a>
                        <a href="{% url 'delete-expenditure' pk=expenditure.pk %}"><i class="bi bi-trash text-danger"></i></a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr class="subtotal">
                <td colspan="3" class="bangla cp-3 text-right">মোটঃ</td>
                <td class="text-right">{{total_expenditures|ezynumber}}</td>
            </tr>
            {% endif %}
            
            {% if duesells %}
            <tr>
                <th colspan="4" class="bangla group-label">বাকি বিক্রয়
                    {% if can_change %}
                    <a href="{% url 'create-duesell-multi' date %}" class="d-print-none"><i class="bi bi-plus-circle text-info"></i></a>
                    {% endif %}
                </th>
            </tr>
            {% for obj in duesells %}
            <tr class="transaction-entry">
                {% if obj.product.type == "Loose" %}
                <td class="bangla">
                    {{obj.customer}} - ({{obj.product.get_type_display}}) {{obj.product.name}}
                </td>
                <td class="text-right">{{obj.quantity|ezynumber}} <span class="bangla">লিঃ</span></td>
                {% else %}
                <td>
                    <span class="bangla">{{obj.customer}}</span> - {{obj.product.brand}} <span class="bangla">({{obj.product.name}})</span>
                </td>
                <td class="text-right">{{obj.product.capacity}} <span class="bangla">লিঃ</span> &times; {{obj.quantity|floatformat:"-2"}} </td>
                {% endif %}
                <td class="text-right">{{obj.amount|ezynumber}}</td>
                <td class="subtotal">
                    {% if can_change %}
                    <div class="d-print-none action-btns">
                        <a href="{% url 'update-duesell' pk=obj.pk %}"><i class="bi bi-pencil-square text-dark"></i></a>
                        <a href="{% url 'delete-duesell' pk=obj.pk %}"><i class="bi bi-trash text-danger"></i></a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr class="subtotal">
                <td colspan="3" class="bangla cp-3 text-right">মোটঃ</td>
                <td class="text-right">{{total_duesells|ezynumber}}</td>
            </tr>
            {% endif %}
            
            {% if withdraws %}
            <tr>
                <th colspan="4" class="bangla group-label">উত্তোলন
                    {% if can_change %}
                    <a href="{% url 'create-withdraw-multi' date %}" class="d-print-none"><i class="bi bi-plus-circle text-info"></i></a>
                    {% endif %}
                </th>
            </tr>
            {% for withdraw in withdraws %}
            <tr class="transaction-entry">
                <td class="bangla" colspan="2">{{withdraw.owner.name}} - {{withdraw.detail}}</td>
                <td class="text-right">{{withdraw.amount|ezynumber}}</td>
                <td class="subtotal">
                    {% if can_change %}
                    <div class="d-print-none action-btns">
                        <a href="{% url 'update-withdraw' pk=withdraw.pk %}"><i class="bi bi-pencil-square text-dark"></i></a>
                        <a href="{% url 'delete-withdraw' pk=withdraw.pk %}"><i class="bi bi-trash text-danger"></i></a>
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            <tr class="subtotal">
                <td colspan="3" class="bangla cp-3 text-right">মোটঃ</td>
                <td class="text-right">{{total_withdraws|ezynumber}}</td>
            </tr>
            {% endif %}

            <tr>
                <th colspan="3" class="bangla cp-3 text-right">সর্বমোটঃ</th>
                <th class="text-right">{{total_credit|ezynumber}}</th>
            </tr>
        </table>
    </div>
    <div class="col-sm-6">
        {% if balance_cf_side == 'debit' %}
        {% include "./balance_cf.html" %}
        {% endif %}
    </div>
    <div class="col-sm-6">
        {% if balance_cf_side == 'credit' %}
        {% include "./balance_cf.html" %}
        {% endif %}
    </div>
    {% else %}
    <div class="col-sm-12">
        <div class="text-center m-5 text-secondary">
            <div class="display-3 bangla">দুঃখিত! প্রাথমিক ব্যাল্যান্স নেই</div>
            <a href="{% url 'create-cashbalance' date %}" class="btn btn-primary m-3">Add balance</a>
        </div>
    </div>
    {% endif %}
</div>

<script>
    $(document).ready(function(){
        $('#dr-plus').hover(function(){
            $('#dr-add-btn').toggle('fast')
        });
        $('#cr-plus').hover(function(){
            $('#cr-add-btn').toggle('fast')
        });

        // Action Button toggle
        $(".transaction-entry").mouseenter(function(){
            $(this).find(".action-btns").show();
        });
        $(".transaction-entry").mouseleave(function(){
            $(this).find(".action-btns").hide();
        });

        // Show Subtotal
        $('#show-subtotal').click(function(){
            if($(this).is(":checked")){
                $('.subtotal').removeClass('d-none')
                $('.cp-3').attr('colspan',3)
                $('.group-label').attr('colspan',4)
            } else {
                $('.subtotal').addClass('d-none')
                $('.cp-3').attr('colspan',2)
                $('.group-label').attr('colspan',3)
            }
        })

        // Print function
        $('#print').click(function(){
            window.print()
        })
    });
</script>

{% endblock main %}